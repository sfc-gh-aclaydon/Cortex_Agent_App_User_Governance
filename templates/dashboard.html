<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .query-result { margin-top: 20px; }
        .sql-block { 
            background-color: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            font-family: monospace; 
            border: 1px solid #dee2e6;
        }
        .loading { display: none; }
        .regions-list { font-size: 0.9em; color: #6c757d; }
        .sample-question { 
            cursor: pointer; 
            transition: background-color 0.2s;
        }
        .sample-question:hover {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Analytics Dashboard</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">Welcome, <span id="username"></span></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>Ask a Question</h5>
                        <small class="text-muted">Use natural language to query your data</small>
                    </div>
                    <div class="card-body">
                        <form id="queryForm">
                            <div class="mb-3">
                                <label for="question" class="form-label">Natural Language Query:</label>
                                <textarea class="form-control" id="question" rows="3" 
                                    placeholder="e.g., What were our top 3 customers by revenue last quarter?"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                Ask Question
                                <div class="loading spinner-border spinner-border-sm ms-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </button>
                        </form>
                        
                        <div id="queryResult" class="query-result"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6>Your Access</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>User:</strong> <span id="userInfo"></span></p>
                        <p><strong>Accessible Regions:</strong></p>
                        <ul id="regionsList" class="regions-list"></ul>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h6>Sample Questions</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-secondary btn-sm sample-question" 
                                onclick="askSample('What were our total sales by region last quarter?')">
                                Sales by Region
                            </button>
                            <button class="btn btn-outline-secondary btn-sm sample-question" 
                                onclick="askSample('Which customers had the highest revenue this year?')">
                                Top Customers
                            </button>
                            <button class="btn btn-outline-secondary btn-sm sample-question" 
                                onclick="askSample('Show me software sales by quarter')">
                                Software Sales
                            </button>
                            <button class="btn btn-outline-secondary btn-sm sample-question" 
                                onclick="askSample('What is our top performing product category?')">
                                Top Category
                            </button>
                            <button class="btn btn-outline-secondary btn-sm sample-question" 
                                onclick="askSample('Which sales rep had the most deals?')">
                                Top Sales Rep
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentRequestId = null;

        // Load user profile on page load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/api/auth/profile');
                if (response.ok) {
                    const userData = await response.json();
                    
                    // Update UI with user info
                    document.getElementById('username').textContent = userData.full_name || userData.username;
                    document.getElementById('userInfo').textContent = userData.full_name || userData.username;
                    
                    // Update regions list
                    const regionsList = document.getElementById('regionsList');
                    regionsList.innerHTML = '';
                    if (userData.regions && userData.regions.length > 0) {
                        userData.regions.forEach(region => {
                            const li = document.createElement('li');
                            li.textContent = `${region.region_name} (${region.region_code})`;
                            regionsList.appendChild(li);
                        });
                    } else {
                        const li = document.createElement('li');
                        li.textContent = 'No regions assigned';
                        regionsList.appendChild(li);
                    }
                } else {
                    // Redirect to login if not authenticated
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Failed to load user profile:', error);
                window.location.href = '/';
            }
        });

        // Handle query form submission
        document.getElementById('queryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const question = document.getElementById('question').value.trim();
            if (!question) {
                alert('Please enter a question');
                return;
            }
            
            askQuestion(question);
        });

        function askSample(question) {
            document.getElementById('question').value = question;
            askQuestion(question);
        }

        async function askQuestion(question) {
            const loadingSpinner = document.querySelector('.loading');
            const resultDiv = document.getElementById('queryResult');
            
            try {
                loadingSpinner.style.display = 'inline-block';
                resultDiv.innerHTML = '<div class="alert alert-info">Processing your question...</div>';
                
                const response = await fetch('/api/query/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: question })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Request failed');
                }
                
                displayResult(data);
                currentRequestId = data.request_id;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        function displayResult(data) {
            const resultDiv = document.getElementById('queryResult');
            let html = '<div class="alert alert-success"><strong>Query Results:</strong></div>';
            
            if (data.content && data.content.length > 0) {
                data.content.forEach(item => {
                    if (item.type === 'text') {
                        html += `<div class="mb-3"><p>${escapeHtml(item.content)}</p></div>`;
                    } else if (item.type === 'sql') {
                        html += `
                            <div class="mb-3">
                                <h6>Generated SQL:</h6>
                                <div class="sql-block">
                                    <pre><code>${escapeHtml(item.content)}</code></pre>
                                </div>
                                ${item.confidence ? `<small class="text-muted">Confidence: ${JSON.stringify(item.confidence)}</small>` : ''}
                            </div>
                        `;
                        
                        // Display query results if available
                        if (item.results) {
                            if (item.results.success && item.results.data && item.results.data.length > 0) {
                                html += `
                                    <div class="mb-3">
                                        <h6>Query Results (${item.results.row_count} rows):</h6>
                                        <div class="table-responsive">
                                            <table class="table table-striped table-sm">
                                                <thead class="table-dark">
                                                    <tr>
                                                        ${item.results.columns.map(col => `<th>${escapeHtml(col)}</th>`).join('')}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${item.results.data.slice(0, 50).map(row => `
                                                        <tr>
                                                            ${item.results.columns.map(col => `
                                                                <td>${escapeHtml(row[col] !== null ? row[col].toString() : '')}</td>
                                                            `).join('')}
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                        ${item.results.row_count > 50 ? `<small class="text-muted">Showing first 50 rows of ${item.results.row_count} total results.</small>` : ''}
                                    </div>
                                `;
                            } else if (item.results.success && item.results.row_count === 0) {
                                html += `
                                    <div class="mb-3">
                                        <div class="alert alert-info">
                                            <strong>No Results:</strong> The query executed successfully but returned no data.
                                        </div>
                                    </div>
                                `;
                            } else if (!item.results.success) {
                                html += `
                                    <div class="mb-3">
                                        <div class="alert alert-warning">
                                            <strong>Query Execution Error:</strong> ${escapeHtml(item.results.error || 'Unknown error')}
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    } else if (item.type === 'data_summary') {
                        html += `
                            <div class="mb-3">
                                <div class="alert alert-info">
                                    <strong>Summary:</strong> ${escapeHtml(item.content)}
                                </div>
                            </div>
                        `;
                    } else if (item.type === 'suggestions') {
                        html += `
                            <div class="mb-3">
                                <h6>Suggestions:</h6>
                                <ul>
                                    ${item.content.map(suggestion => `<li>${escapeHtml(suggestion)}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                });
            }
            
            // Add feedback section
            if (currentRequestId) {
                html += `
                    <div class="mt-3 pt-3 border-top">
                        <h6>Was this helpful?</h6>
                        <button class="btn btn-success btn-sm me-2" onclick="submitFeedback(true)">
                            👍 Yes
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="submitFeedback(false)">
                            👎 No
                        </button>
                    </div>
                `;
            }
            
            // Add warnings if any
            if (data.warnings && data.warnings.length > 0) {
                html += `
                    <div class="alert alert-warning mt-3">
                        <strong>Warnings:</strong>
                        <ul class="mb-0">
                            ${data.warnings.map(warning => `<li>${escapeHtml(warning.message || warning)}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            resultDiv.innerHTML = html;
        }

        async function submitFeedback(positive) {
            if (!currentRequestId) return;
            
            try {
                const response = await fetch('/api/query/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        request_id: currentRequestId,
                        positive: positive
                    })
                });
                
                if (response.ok) {
                    // Replace feedback buttons with thank you message
                    const feedbackDiv = document.querySelector('.border-top');
                    if (feedbackDiv) {
                        feedbackDiv.innerHTML = `
                            <div class="text-success">
                                <small>Thank you for your feedback!</small>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Feedback submission failed:', error);
            }
        }

        async function logout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/';
            }
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
    </script>
</body>
</html>
